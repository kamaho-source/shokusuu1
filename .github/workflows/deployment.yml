name: Deploy to Sakura VPS

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-to-vps
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu          # 22番ポートで ubuntu ユーザー
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}   # OpenSSH形式の秘密鍵（複数行のまま）
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}   # ある場合のみ
          timeout: 60s
          command_timeout: 20m
          script: |
            set -euo pipefail

            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"   # 例: /var/www/kamakura-shokusu
            REPO_URL="${{ secrets.REPO_URL }}"         # 例: git@github.com:oohashikazuyuki/shokusuu1.git
            BRANCH="${BRANCH:-main}"

            # 1) ディレクトリ作成（未作成時）＆ 所有権付与（/var/www 直下など root 所有の場合を想定）
            if [ ! -d "$DEPLOY_PATH" ]; then
              sudo mkdir -p "$DEPLOY_PATH"
            fi
            sudo chown -R "$USER":"$USER" "$DEPLOY_PATH"

            cd "$DEPLOY_PATH"

            # 2) 初回 or 既存の判定
            if [ ! -d .git ]; then
              if [ -z "$REPO_URL" ]; then
                echo "ERROR: REPO_URL secret is empty. Set secrets.REPO_URL to your Git repository URL (SSH recommended)." >&2
                exit 1
              fi
              # 初回 clone
              git clone --branch "$BRANCH" "$REPO_URL" .
            else
              # 既存: fetch & hard reset
              git fetch origin --prune
              git checkout "$BRANCH" || git checkout -b "$BRANCH"
              git reset --hard "origin/$BRANCH"
            fi

            # 3) （必要に応じて）ビルド/コンテナ再起動
            # if [ -f composer.json ]; then
            #   composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            # fi
            # if [ -f package.json ]; then
            #   npm ci --no-audit --no-fund
            #   npm run build
            # fi
            # if [ -f docker-compose.yml ] || [ -f compose.yml ]; then
            #   docker compose pull
            #   docker compose up -d --remove-orphans
            #   docker image prune -f
            # fi
            # if [ -f bin/cake ]; then
            #   php bin/cake cache clear_all || true
            # fi
            # if [ -f artisan ]; then
            #   php artisan config:cache || true
            #   php artisan route:cache || true
            # fi

            echo "Deployed: $(git rev-parse --short HEAD) on $(date -u +%Y-%m-%dT%H:%M:%SZ)"
