name: Deploy to Sakura VPS

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-to-vps
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ubuntu
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -euo pipefail

            DEPLOY_PATH="/home/ubuntu/shokusuu1"
            REPO_URL="${{ secrets.REPO_URL }}"   # 例: git@github.com:oohashikazuyuki/shokusuu1.git
            BRANCH="${BRANCH:-main}"

            # デプロイ先へ移動（初回は空ディレクトリ想定）
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"

            # 初回 clone or 既存更新
            if [ ! -d .git ]; then
              if [ -z "$REPO_URL" ]; then
                echo "ERROR: secrets.REPO_URL が未設定です（例: git@github.com:oohashikazuyuki/shokusuu1.git）。" >&2
                exit 1
              fi
              echo "[INIT] cloning $REPO_URL (branch: $BRANCH)"
              git clone --branch "$BRANCH" "$REPO_URL" .
            else
              echo "[UPDATE] fetching & resetting to origin/$BRANCH"
              git fetch origin --prune
              git checkout "$BRANCH" || git checkout -b "$BRANCH"
              git reset --hard "origin/$BRANCH"
            fi

            # 必要に応じて有効化（例）
            # if [ -f docker-compose.yml ] || [ -f compose.yml ]; then
            #   docker compose pull
            #   docker compose up -d --remove-orphans
            #   docker image prune -f
            # fi
            # if [ -f bin/cake ]; then
            #   php bin/cake cache clear_all || true
            # fi

            echo "✅ Deployed: $(git rev-parse --short HEAD) @ $(date -u +%Y-%m-%dT%H:%M:%SZ)"
