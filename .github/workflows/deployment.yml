name: Deploy to Sakura VPS

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-to-vps
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OpenSSH形式の秘密鍵を Secrets（SSH_PRIVATE_KEY）に「複数行のまま」保存している前提
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}        # 例: 203.0.113.10
          username: ubuntu                     # ポート22でubuntuユーザーに接続
          port: 22
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # -----BEGIN OPENSSH PRIVATE KEY----- から END まで
          # パスフレーズ付きなら有効化
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}
          timeout: 60s
          command_timeout: 20m
          script: |
            set -euo pipefail

            # デプロイ先へ移動
            cd "${{ secrets.DEPLOY_PATH }}"

            # Git を最新化（ローカル変更は破棄）
            git fetch origin --prune
            git checkout main || true
            git reset --hard origin/main

            # --- 必要に応じて有効化（CakePHP/Laravel/Node/Docker） ---
            # if [ -f composer.json ]; then
            #   composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            # fi
            # if [ -f package.json ]; then
            #   npm ci --no-audit --no-fund
            #   npm run build
            # fi
            # if [ -f docker-compose.yml ] || [ -f compose.yml ]; then
            #   docker compose pull
            #   docker compose up -d --remove-orphans
            #   docker image prune -f
            # fi
            # if [ -f bin/cake ]; then
            #   php bin/cake cache clear_all || true
            # fi
            # if [ -f artisan ]; then
            #   php artisan config:cache || true
            #   php artisan route:cache || true
            # fi

            echo "Deployed: $(git rev-parse --short HEAD) on $(date -u +%Y-%m-%dT%H:%M:%SZ)"
