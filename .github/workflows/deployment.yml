
name: Deploy to Sakura VPS

on:
  push:
    branches: [ main ]

# 同時実行の競合を防止（最新のみ実行）
concurrency:
  group: deploy-to-vps
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout (for metadata)
        uses: actions/checkout@v4

      # SSH で直接 VPS 上の作業ディレクトリへ入り、git 同期や Docker 再起動を行う
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}        # 例: 203.0.113.10
          username: ${{ secrets.VPS_USER }}    # 例: ubuntu
          port: ${{ secrets.VPS_PORT }}        # 例: 22（省略可）
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # OpenSSH 形式の秘密鍵（複数行のまま Secrets に保存）
          # 鍵にパスフレーズがある場合のみ有効化
          # passphrase: ${{ secrets.SSH_PASSPHRASE }}
          script_stop: true
          command_timeout: 20m
          script: |
            set -euo pipefail

            # デプロイ先へ移動
            cd "${{ secrets.DEPLOY_PATH }}"  # 例: /var/www/kamakura-shokusu

            # Git を最新化（ローカル変更は破棄）
            git fetch origin --prune
            git checkout main || true
            git reset --hard origin/main

            # --- 必要に応じて有効化してください（CakePHP/Laravel/Node/Docker） ---
            # Composer（PHP依存関係）
            # if [ -f composer.json ]; then
            #   composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
            # fi

            # Node ビルド（フロント）
            # if [ -f package.json ]; then
            #   npm ci --no-audit --no-fund
            #   npm run build
            # fi

            # Docker Compose（該当プロジェクトの場合）
            # if [ -f docker-compose.yml ] || [ -f compose.yml ]; then
            #   docker compose pull
            #   docker compose up -d --remove-orphans
            #   docker image prune -f
            # fi

            # CakePHP / Laravel のキャッシュ類（該当時のみ）
            # if [ -f bin/cake ]; then
            #   php bin/cake cache clear_all || true
            # fi
            # if [ -f artisan ]; then
            #   php artisan config:cache || true
            #   php artisan route:cache || true
            # fi

            echo "Deployed: $(git rev-parse --short HEAD) on $(date -u +%Y-%m-%dT%H:%M:%SZ)"
